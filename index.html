<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UC Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b2b2b">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Arial;margin:0;padding:15px;background:#f4f4f4}
h1,h2,h3{margin-top:0}
.card{background:#fff;padding:12px;margin-bottom:15px;border-radius:8px}
input,button{width:100%;padding:10px;margin-top:6px;font-size:16px}
button{font-weight:bold}
.total{font-size:18px;font-weight:bold}
.item{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:6px 0}
.item span{flex:1}
.btn{margin-left:5px}
.del{background:#d9534f;color:#fff;border:none;padding:6px 10px;border-radius:4px}
.edit{background:#0275d8;color:#fff;border:none;padding:6px 10px;border-radius:4px}
.small{font-size:14px;color:#555}
</style>
</head>

<body>

<h1>UC Earnings</h1>
<h2 id="period"></h2>

<div class="card">
<h3>Add / Edit Income</h3>
<input type="hidden" id="iEdit">
<input type="date" id="iDate">
<input type="text" id="iDesc" placeholder="Description">
<input type="number" id="iAmt" placeholder="£">
<button onclick="saveIncome()">Save Income</button>
<div id="incomeList"></div>
</div>

<div class="card">
<h3>Add / Edit Expense</h3>
<input type="hidden" id="eEdit">
<input type="date" id="eDate">
<input type="text" id="eDesc" placeholder="Description">
<input type="number" id="eAmt" placeholder="£">
<button onclick="saveExpense()">Save Expense</button>
<div id="expenseList"></div>
</div>

<div class="card">
<h3>Recurring Monthly Expenses</h3>
<input type="hidden" id="rEdit">
<input type="text" id="rDesc" placeholder="Description">
<input type="number" id="rAmt" placeholder="£">
<button onclick="saveRecurring()">Save Recurring</button>
<div id="rList" class="small"></div>
</div>

<div class="card">
<h3>Totals</h3>
<div id="totals" class="total"></div>
</div>

<button onclick="saveMonth()">Save Period & Start Next</button>
<button onclick="exportPDF()">Export PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let store=JSON.parse(localStorage.getItem("ucPWA2"))||{
 months:[],
 current:newMonth(new Date()),
 recurring:[]
};

function newMonth(d){
 let s=new Date(d);
 if(s.getDate()<28)s.setMonth(s.getMonth()-1);
 s.setDate(28);
 return {start:s,income:[],expenses:[]};
}

function endOf(s){
 let e=new Date(s);
 e.setMonth(e.getMonth()+1);
 e.setDate(27);
 return e;
}

function f(d){return d.toISOString().split("T")[0]}

function update(){
 let m=store.current;
 let s=new Date(m.start),e=endOf(s);
 period.innerText=`Assessment Period: ${s.toDateString()} – ${e.toDateString()}`;

 let it=m.income.reduce((a,b)=>a+b.amount,0);
 let et=m.expenses.reduce((a,b)=>a+b.amount,0);
 totals.innerText=`Income £${it.toFixed(2)} | Expenses £${et.toFixed(2)} | Net £${(it-et).toFixed(2)}`;

 incomeList.innerHTML="";
 m.income.forEach((i,n)=>row(incomeList,`${i.date} – ${i.desc} – £${i.amount}`,()=>editIncome(n),()=>delIncome(n)));

 expenseList.innerHTML="";
 m.expenses.forEach((x,n)=>row(expenseList,`${x.date} – ${x.desc} – £${x.amount}`,()=>editExpense(n),()=>delExpense(n)));

 rList.innerHTML="";
 store.recurring.forEach((r,n)=>{
  let d=document.createElement("div");
  d.className="item";
  d.innerHTML=`<span>${r.desc} – £${r.amount}</span>`;
  let e=document.createElement("button");
  e.className="edit btn";
  e.innerText="Edit";
  e.onclick=()=>editRecurring(n);
  let x=document.createElement("button");
  x.className="del btn";
  x.innerText="Del";
  x.onclick=()=>confirm("Delete recurring expense?")&&delRecurring(n);
  d.appendChild(e);
  d.appendChild(x);
  rList.appendChild(d);
 });

 localStorage.setItem("ucPWA2",JSON.stringify(store));
}

function row(parent,text,editFn,delFn){
 let d=document.createElement("div");
 d.className="item";
 d.innerHTML=`<span>${text}</span>`;
 let e=document.createElement("button");
 e.className="edit btn";
 e.innerText="Edit";
 e.onclick=editFn;
 let x=document.createElement("button");
 x.className="del btn";
 x.innerText="Del";
 x.onclick=()=>confirm("Delete entry?")&&delFn();
 d.appendChild(e);
 d.appendChild(x);
 parent.appendChild(d);
}

function saveIncome(){
 let m=store.current,i=iEdit.value;
 let o={date:iDate.value||f(new Date()),desc:iDesc.value,amount:+iAmt.value};
 i!==""?m.income[i]=o:m.income.push(o);
 iEdit.value="";
 update();
}

function saveExpense(){
 let m=store.current,i=eEdit.value;
 let o={date:eDate.value||f(new Date()),desc:eDesc.value,amount:+eAmt.value};
 i!==""?m.expenses[i]=o:m.expenses.push(o);
 eEdit.value="";
 update();
}

function editIncome(i){let x=store.current.income[i];iEdit.value=i;iDate.value=x.date;iDesc.value=x.desc;iAmt.value=x.amount}
function editExpense(i){let x=store.current.expenses[i];eEdit.value=i;eDate.value=x.date;eDesc.value=x.desc;eAmt.value=x.amount}

function delIncome(i){store.current.income.splice(i,1);update()}
function delExpense(i){store.current.expenses.splice(i,1);update()}

function saveRecurring(){
 let i=rEdit.value;
 let o={desc:rDesc.value,amount:+rAmt.value};
 i!==""?store.recurring[i]=o:store.recurring.push(o);
 rEdit.value="";
 update();
}

function editRecurring(i){
 let r=store.recurring[i];
 rEdit.value=i;
 rDesc.value=r.desc;
 rAmt.value=r.amount;
}

function delRecurring(i){
 store.recurring.splice(i,1);
 update();
}

function saveMonth(){
 store.months.push(store.current);
 let n=new Date(store.current.start);
 n.setMonth(n.getMonth()+1);
 store.current=newMonth(n);
 store.current.expenses=store.recurring.map(r=>({date:f(n),desc:r.desc,amount:r.amount}));
 update();
}

function exportPDF(){
 const{jsPDF}=window.jspdf;
 let p=new jsPDF();
 p.text("Universal Credit Earnings Report",10,10);
 p.text(period.innerText,10,20);
 let y=30;
 p.text("Income",10,y);
 store.current.income.forEach(i=>{y+=8;p.text(`${i.date} ${i.desc} £${i.amount}`,10,y)});
 y+=10;
 p.text("Expenses",10,y);
 store.current.expenses.forEach(e=>{y+=8;p.text(`${e.date} ${e.desc} £${e.amount}`,10,y)});
 p.save("UC_Earnings_Report.pdf");
}

if("serviceWorker"in navigator"){
 navigator.serviceWorker.register("service-worker.js");
}
update();
</script>

</body>
</html>
